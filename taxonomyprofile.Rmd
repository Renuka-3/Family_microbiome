---
title: "taxonomyprofile"
author: "Renuka"
date: "2022-10-15"
output: html_document
---

```{r taxonomypicture, include=FALSE}
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(knitr)
require(knitcitations)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
core_detection <- .1/100
core_prevalence <- 20/100
# Was created with: source("create_phyloseq.R")
physeqnew <- readRDS("inputdata/processed/phyloseq/physeqnew.RDS")
temp.phy <- filter_taxa(physeqnew, function (x) {sum(x > 0) > 1}, prune=TRUE)
#summarize_phyloseq(temp.phy)
#get_taxa_unique(temp.phy, "Genus")
```



# Core microbiota.

Core microbiota is here defined based on the following parameters:

  * Detection threshold (relative abundance): `r 100 * core_detection`%
  * Prevalence threshold (above threshold in the population) `r 100 * core_prevalence`%.

The following taxonomic groups are in the core genera. Mean relative abundance and population prevalence (above detection threshold) are shown.


Phylum abundance table (relative abundance % and prevalance):

```{r core_phyla, echo=FALSE, message=FALSE, fig.width=10, fig.height=8, out.width="50%"}
ps <- aggregate_taxa(temp.phy, "Phylum")
ps <- microbiome::transform(ps, "compositional")
ps.core <- core(ps, detection = core_detection, prevalence = core_prevalence)
m <- round(100 * rowMeans(abundances(ps.core)), 1)
median <- round(100 * apply(abundances(ps.core), 1, median), 1)
###sd <- round(100 * apply(abundances(ps.core), 1, sd), 1)
#Right#sd <- round(apply(abundances(ps.core), 1, sd), 2)
###sd <- sd(abundances(ps.core))
prev <- round(100 * prevalence(ps.core, detection = core_detection), 1)
d <- as.data.frame(list(Taxon = names(m), Abundance_mean = m, Prevalence = prev, median = median))
rownames(d) <- NULL
d <- d %>% arrange(desc(Abundance_mean), desc(Prevalence))
colnames(d) <- c("Taxon", "Mean Relative abundance (%)", "Prevalence (%)", "Median")
kable(d)
```

## Genus abundance table (relative abundance % and prevalance):

```{r core_genera, echo=FALSE, message=FALSE, results='hide', fig.width=10, fig.height=8, out.width="50%"}
library(knitr)
a <- aggregate_taxa(temp.phy, level = "Genus")
xc <- abundances(transform(a, "compositional"))
df <- melt(xc)
names(df) <- c("Genus", "sample", "value")
dfm <- df %>% group_by(Genus) %>% 
         summarise(mean = round(100 * mean(value), 1),
	           median = round(100 * median(value), 1),
		   #min = round(100 * min(value), 1),
		   #max = round(100 * max(value), 1),
		   prevalence = round(100 * prevalence(value), 1),
		   sd= round(sd(value),2))%>%
	 arrange(desc(mean))
kable(dfm) 
#write.csv(dfm, file="genus table.csv")
library(data.table)
a <- data.table:::print.data.table(dfm, nrows = 30, topn=5)
```

## Most prevalent genera

```{r core_abundance, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.show="hold"}
theme_set(theme_bw(base_size = 18))
core_detection1 <- .1/100
core_prevalence <- 20/100
b <- aggregate_taxa(temp.phy, "Genus")
b <- microbiome::transform(b, "compositional")
b.core <- core(b, detection = core_detection1, prevalence = core_prevalence)
x <- prevalence(b.core)
bs <- melt(abundances(b.core))
bs$new <- bs$Var1
#bs$new <- gsub(bs$new, pattern = "Propionibacterium", replacement = "Cutibacterium")
#names(x) <- gsub(names(x), pattern = "Propionibacterium", replacement = "Cutibacterium")
df <- data.frame(Genus = names(x), prevalence = x) %>% arrange(prevalence)
sorted.names <- df$Genus 
df$Genus <- factor(df$Genus, levels = sorted.names)
bs$new <- factor(bs$new, levels=sorted.names)
p1 <- ggplot(bs, aes(x = new, y = value)) +
       geom_boxplot() +
       geom_jitter(width = 0.1) +
       #scale_y_continuous(label = scales::percent) +   
       scale_y_log10() +
       coord_flip() + theme(legend.position="none") +
       labs(y = "log abundance", x = '', title = "Most prevalent genera")
print(p1)
```


## Phyla level individual relative abundance bar graph

```{r chunk label, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=6}
transform <- microbiome::transform
j <- transform(temp.phy, "compositional")
sp <- aggregate_taxa(j, "Genus")
o <- aggregate_rare(sp, level = 'Genus',detection = 0.1/100, prevalence = 20/100, include.lowest =TRUE)
phyla.ordering <- names(sort(rowMeans(abundances(transform(o, "compositional")))))
df <- psmelt(o)
#df$Phylum <- factor(df$phylum, levels=phyla.ordering)
sorted.samples.by.Staphylococcus <- unlist(subset(df, Genus=="Staphylococcus") %>% arrange(Abundance) %>% select(Sample))
df$Sample <- factor(df$Sample, levels = sorted.samples.by.Staphylococcus)
#w <- df %>% filter (Family=="A")
#f <- ggplot(w, aes(x = Sample, fill = Genus, y = Abundance)) + geom_bar(stat = "identity", colour = "black") + 
#            labs(y =  "Relative abundance (%)", x = "Individuals") + scale_y_continuous(label=scales::percent) + scale_fill_brewer("Phylum", palette = "Set3") + facet_grid(Family ~ .) + facet_grid(cols = vars(Family)) + theme(axis.text.x = element_blank(),legend.position = "none") 
#print(f)

pl <- ggplot(df, aes(x=Family, fill= Genus, y= Abundance))+ geom_bar(stat = "identity") + labs(y =  "Relative abundance (%)", x = "Family") + scale_y_continuous(label=scales::percent) 
print(pl)
```


